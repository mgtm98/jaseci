name: Build Standalone Binaries

on:
  release:
    types: [published]

  workflow_dispatch:
    inputs:
      jaseci_version:
        description: "jaseci version to build (must exist on PyPI, e.g. 2.3.2)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  # --- Resolve versions ---
  # jaseci and jaclang have independent version numbers.
  # The jaseci version comes from the release tag or manual input.
  # The jaclang version is read from jaseci's pinned dependency on PyPI.
  resolve-versions:
    runs-on: ubuntu-latest
    outputs:
      jaseci_version: ${{ steps.versions.outputs.jaseci_version }}
      jaclang_version: ${{ steps.versions.outputs.jaclang_version }}
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Resolve jaclang version from jaseci dependency
        id: versions
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            JASECI_VERSION="${{ github.event.release.tag_name }}"
            JASECI_VERSION="${JASECI_VERSION#v}"
          else
            JASECI_VERSION="${{ inputs.jaseci_version }}"
          fi
          echo "jaseci_version=$JASECI_VERSION" >> "$GITHUB_OUTPUT"
          echo "jaseci version: $JASECI_VERSION"

          # Install jaseci to resolve the exact jaclang version it pins
          pip install "jaseci==$JASECI_VERSION" --dry-run 2>&1 | tee /tmp/pip-resolve.txt
          JACLANG_VERSION=$(grep -oP 'jaclang==\K[0-9]+\.[0-9]+\.[0-9]+' /tmp/pip-resolve.txt | head -1)

          if [ -z "$JACLANG_VERSION" ]; then
            # Fallback: install and inspect
            pip install "jaseci==$JASECI_VERSION"
            JACLANG_VERSION=$(pip show jaclang | grep -oP '^Version: \K.*')
          fi

          echo "jaclang_version=$JACLANG_VERSION" >> "$GITHUB_OUTPUT"
          echo "jaclang version: $JACLANG_VERSION"

  # --- Build jaclang (slim, core only) ---
  build-jaclang:
    needs: resolve-versions
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x86_64
          - os: macos-latest
            platform: macos-aarch64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install pex
        run: pip install pex

      - name: Build standalone binary
        run: |
          VERSION="${{ needs.resolve-versions.outputs.jaclang_version }}"
          ASSET="jac-${VERSION}-${{ matrix.platform }}"
          echo "Building ${ASSET}..."

          pex \
            "jaclang==${VERSION}" \
            --console-script jac \
            --scie eager \
            --interpreter-constraint "CPython==3.12.*" \
            -o "$ASSET"

          echo "asset_name=${ASSET}" >> "$GITHUB_ENV"

      - name: Verify binary
        run: |
          chmod +x "${{ env.asset_name }}"
          echo "Running --version check..."
          ./${{ env.asset_name }} --version || true

      - name: Generate checksum
        run: |
          if command -v sha256sum &>/dev/null; then
            sha256sum "${{ env.asset_name }}" > "${{ env.asset_name }}.sha256"
          else
            shasum -a 256 "${{ env.asset_name }}" > "${{ env.asset_name }}.sha256"
          fi
          echo "Checksum:"
          cat "${{ env.asset_name }}.sha256"

      - name: Upload to GitHub Release
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "${{ github.event.release.tag_name }}" \
            "${{ env.asset_name }}" \
            "${{ env.asset_name }}.sha256" \
            --clobber

      - name: Upload as artifact (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.asset_name }}
          path: |
            ${{ env.asset_name }}
            ${{ env.asset_name }}.sha256

  # --- Build jaseci (full, all plugins) ---
  build-jaseci:
    needs: resolve-versions
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x86_64
          - os: macos-latest
            platform: macos-aarch64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install pex
        run: pip install pex

      - name: Build standalone binary
        run: |
          VERSION="${{ needs.resolve-versions.outputs.jaseci_version }}"
          ASSET="jaseci-${VERSION}-${{ matrix.platform }}"
          echo "Building ${ASSET}..."

          pex \
            "jaseci==${VERSION}" \
            --console-script jac \
            --scie eager \
            --interpreter-constraint "CPython==3.12.*" \
            -o "$ASSET"

          echo "asset_name=${ASSET}" >> "$GITHUB_ENV"

      - name: Verify binary
        run: |
          chmod +x "${{ env.asset_name }}"
          echo "Running --version check..."
          ./${{ env.asset_name }} --version || true

      - name: Generate checksum
        run: |
          if command -v sha256sum &>/dev/null; then
            sha256sum "${{ env.asset_name }}" > "${{ env.asset_name }}.sha256"
          else
            shasum -a 256 "${{ env.asset_name }}" > "${{ env.asset_name }}.sha256"
          fi
          echo "Checksum:"
          cat "${{ env.asset_name }}.sha256"

      - name: Upload to GitHub Release
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "${{ github.event.release.tag_name }}" \
            "${{ env.asset_name }}" \
            "${{ env.asset_name }}.sha256" \
            --clobber

      - name: Upload as artifact (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.asset_name }}
          path: |
            ${{ env.asset_name }}
            ${{ env.asset_name }}.sha256

  summary:
    needs: [resolve-versions, build-jaclang, build-jaseci]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Build summary
        run: |
          echo "## Standalone Binary Build Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**jaseci version:** ${{ needs.resolve-versions.outputs.jaseci_version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**jaclang version:** ${{ needs.resolve-versions.outputs.jaclang_version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Package | Platform | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|----------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| jaclang (slim) | linux-x86_64 | ${{ needs.build-jaclang.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| jaclang (slim) | macos-aarch64 | ${{ needs.build-jaclang.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| jaseci (full) | linux-x86_64 | ${{ needs.build-jaseci.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| jaseci (full) | macos-aarch64 | ${{ needs.build-jaseci.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Note:** linux-aarch64 builds can be added when ARM runners are available." >> "$GITHUB_STEP_SUMMARY"
