name: Create GitHub Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (reads from jaseci pyproject.toml if empty)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=$(python3 -c "
          import tomllib
          with open('jaseci-package/pyproject.toml', 'rb') as f:
              print(tomllib.load(f)['project']['version'])
          ")
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Resolved version: $VERSION"

      - name: Check if release already exists
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if gh release view "v${{ steps.version.outputs.version }}" &>/dev/null; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Release v${{ steps.version.outputs.version }} already exists."
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release
        if: steps.check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "v${{ steps.version.outputs.version }}" \
            --title "Jaseci v${{ steps.version.outputs.version }}" \
            --generate-notes \
            --latest
          echo "Created release v${{ steps.version.outputs.version }}"

      - name: Summary
        run: |
          echo "## Release v${{ steps.version.outputs.version }}" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.check.outputs.exists }}" = "true" ]; then
            echo "Release already existed â€” no action taken." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "GitHub Release created. Standalone binary build chained." >> "$GITHUB_STEP_SUMMARY"
          fi

    outputs:
      version: ${{ steps.version.outputs.version }}
      release_created: ${{ steps.check.outputs.exists == 'false' }}

  build-standalone-binaries:
    needs: create-release
    if: needs.create-release.outputs.release_created == 'true'
    uses: ./.github/workflows/build-standalone.yml
    with:
      jaseci_version: ${{ needs.create-release.outputs.version }}
      release_tag: v${{ needs.create-release.outputs.version }}
    permissions:
      contents: write
